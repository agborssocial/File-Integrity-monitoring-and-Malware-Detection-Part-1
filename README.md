# Understanding and Setting Up Wazuh Capabilities - Part 1

## Objective
This lab aims to configure and utilize Wazuh's File Integrity Monitoring (FIM) to track unauthorized changes to critical files, deploy malware detection mechanisms through file hash checks and integration with third-party threat detection platforms like VirusTotal, and configure rootkit detection to identify and mitigate potential rootkit and trojan threats. The objective is to gain a comprehensive understanding of how Wazuh can be leveraged to provide robust security monitoring and incident response capabilities across all endpoints within a network.

## Lab Setup
The lab consists of two Virtual Machines (VMs). The Wazuh server is installed on an Ubuntu VM, and the agent is installed on a Windows VM. VMware is used as the virtualization platform.

### Skills Learned
- Creating and managing FIM rules to detect file modifications and creations that might indicate security breaches or malware behavior.
- Integrating Wazuh with external platforms like VirusTotal for enhanced malware detection.
- Collecting and analyzing logs from various sources, including Windows Defender, to detect potential threats and vulnerabilities.
- Deploying and managing Wazuh in a network environment, including tasks such as configuring agents, managing policies, and troubleshooting issues.
- Proficiency in analyzing and interpreting network logs.

### Tools Used
- Wazuh
- VMware

### Steps
## File Integrity Monitoring (FIM)
Wazuh File Integrity Monitoring (FIM) is managed by the Wazuh FIM module, which is enabled by default. However, some changes to the configuration file are necessary to specify the directories to scan and the scan frequency. In this lab, the directories to be monitored are the Downloads and Desktop directories. Since the Wazuh agent is installed on a Windows endpoint, the configuration file is located at `C:\Program Files (x86)\ossec-agent\ossec.conf`.

### Use Case: Setting Up Wazuh FIM Module to Scan Downloads and Desktop Directories

1. **Backup the Configuration File**  
   Navigate to `C:\Program Files (x86)\ossec-agent\ossec.conf` using Windows File Explorer. Copy and paste the configuration file in the same directory. Rename the copied file to `ossec-original.conf` to mark it as the original or default configuration file.

2. **Configure the FIM Module**  
   Open Notepad with administrator privileges. Use the File menu to navigate to the specified directory and open the `ossec.conf` file. Change the file type in the dialog box from `.txt` to "All Files." Use the Find function and search for "File integrity monitoring." This will highlight the FIM module configuration section. Below the `<disabled>no</disabled>` tag, add the following lines, ensuring proper spacing:
   ```xml
   <directories>C:\Users\<YOUR USERNAME>\Downloads</directories>
   <directories>C:\Users\<YOUR USERNAME>\Desktop</directories>
   ```
   Replace <YOUR USERNAME> with your actual Windows username.
3. **Restart the Wazuh Agent**
   Open PowerShell in Administrator mode and type the following command without quotes:
   ```xml
   Restart-Service -Name Wazuh
   ```
   This command restarts the Wazuh agent, applying the configuration changes.
4. **View FIM Scan Results Using the Wazuh Dashboard**
   Navigate to `Home > Endpoint Security > File Integrity Monitoring > Inventory` to view FIM results. The Inventory tab displays an inventory of all files that the FIM module has indexed, including the filename, last modification date, user, user ID, group, and file size. The Dashboard tab provides an overview of FIM results for all enrolled agents. The Event tab shows events generated by the FIM module.

## Changing Default Scan Settings
### Making FIM Module Scans Real-Time
1. **Configure the FIM Module**
   To make the FIM module scan the Downloads and Desktop directories in real-time, add the realtime="yes" attribute as shown below:
   ```xml
   <directories realtime="yes">C:\Users\<YOUR USERNAME>\Downloads</directories>
   <directories realtime="yes">C:\Users\<YOUR USERNAME>\Desktop</directories>
   ``
Note: Only directories with the realtime attribute will be scanned in real-time. Other directories follow the default scan frequency, which is every 12 hours.
2. **Restart the Wazuh Agent**
   Use the command:
   ```xml
   Restart-Service -Name Wazuh
   ```
3. **Test the Configuration**
   Create a file named manago.txt in the Downloads directory. The creation of this file should be immediately reflected in the Events tab.

## Changing the Frequency of Scans
1. **Configure the FIM Module**
   Modify the frequency tag in the FIM configuration section to change the scan frequency. For example, setting it to 3:
   ```xml
   <frequency>3</frequency>
   ```
2. **Restart the Wazuh Agent**
   Use the command:
   ```xml
      Restart-Service -Name Wazuh
   ```
3. **View Result**
   A newly added file will generate an event after just 3 seconds.

## Generating an Alert for File Modification
1. **Modify the File**
   Open the manago.txt file and add the text "This is THE Lab."

2. **Result**
   An alert is generated for the file modification in the Events tab.

## Reporting Exact Modification Changes
   Wazuh can report the exact changes made to files it monitors.

1. **Configure the FIM Module**
Open the ossec.conf file to the File Integrity Monitoring section and add the report_changes attribute:

xml
Copy code
<directories report_changes="yes">C:\Users\<YOUR USERNAME>\Downloads</directories>
Test the Configuration
Add the text "This is THE Lab" to the manago1.txt file. The content of the file should now be "This is THE Lab This is THE Lab."

Result
The exact changes made to the file are reported.

Preventing Data Leakage with nodiff
When using the report_changes option, you can use the nodiff option to prevent Wazuh from reporting the exact content changed in a file, thereby avoiding potential data leakage.

Ignoring Directories
Wazuh FIM can be configured to ignore specific directories, with ignored directories taking precedence over monitored ones.

Setting Up the Test Environment
Create a folder named Tanubu in the Downloads directory and add a new text document inside it. This newly added file should be displayed in the Wazuh dashboard.

Configure the FIM Module
Open the ossec.conf file and add the path of the Tanubu directory to an ignore tag as shown below:

xml
Copy code
<ignore>C:\Users\<YOUR USERNAME>\Downloads\Tanubu</ignore>
Restart the Wazuh Agent
Use the command:

bash
Copy code
Restart-Service -Name Wazuh
Test the Configuration
Add the text "There will be no change" to the created text file.

Result
The change is not recorded by the FIM module.
