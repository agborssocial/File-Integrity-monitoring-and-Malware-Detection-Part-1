# Understanding and Setting Up Wazuh Capabilities - Part 1

## Objective
This lab aims to configure and utilize Wazuh's File Integrity Monitoring (FIM) to track unauthorized changes to critical files, deploy malware detection mechanisms through file hash checks and integration with third-party threat detection platforms like VirusTotal, and configure rootkit detection to identify and mitigate potential rootkit and trojan threats. The objective is to gain a comprehensive understanding of how Wazuh can be leveraged to provide robust security monitoring and incident response capabilities across all endpoints within a network.

## Lab Setup
The lab consists of two Virtual Machines (VMs). The Wazuh server is installed on an Ubuntu VM, and the agent is installed on a Windows VM. VMware is used as the virtualization platform.

### Skills Learned
- Creating and managing FIM rules to detect file modifications and creations that might indicate security breaches or malware behavior.
- Integrating Wazuh with external platforms like VirusTotal for enhanced malware detection.
- Collecting and analyzing logs from various sources, including Windows Defender, to detect potential threats and vulnerabilities.
- Deploying and managing Wazuh in a network environment, including tasks such as configuring agents, managing policies, and troubleshooting issues.
- Proficiency in analyzing and interpreting network logs.

### Tools Used
- Wazuh
- VMware
### Steps
## File Integrity Monitoring (FIM)
Wazuh File Integrity Monitoring (FIM) is managed by the Wazuh FIM module, which is enabled by default. However, some changes to the configuration file are necessary to specify the directories to scan and the scan frequency. In this lab, the directories to be monitored are the Downloads and Desktop directories. Since the Wazuh agent is installed on a Windows endpoint, the configuration file is located at `C:\Program Files (x86)\ossec-agent\ossec.conf`.

### Use Case: Setting Up Wazuh FIM Module to Scan Downloads and Desktop Directories

1. **Backup the Configuration File**  
   Navigate to `C:\Program Files (x86)\ossec-agent\ossec.conf` using Windows File Explorer. Copy and paste the configuration file in the same directory. Rename the copied file to `ossec-original.conf` to mark it as the original or default configuration file.

2. **Configure the FIM Module**  
   Open Notepad with administrator privileges. Use the File menu to navigate to the specified directory and open the `ossec.conf` file. Change the file type in the dialog box from `.txt` to "All Files." Use the Find function and search for "File integrity monitoring." This will highlight the FIM module configuration section. Below the `<disabled>no</disabled>` tag, add the following lines, ensuring proper spacing:
   ```xml
   <directories>C:\Users\<YOUR USERNAME>\Downloads</directories>
   <directories>C:\Users\<YOUR USERNAME>\Desktop</directories>
   ```
   Replace <YOUR USERNAME> with your actual Windows username. In the case of this lab, the username is `Python`
3. **Restart the Wazuh Agent**  
   Open PowerShell in Administrator mode and type the following command without quotes:
      ```xml
      Restart-Service -Name Wazuh
      ```
   This command restarts the Wazuh agent, applying the configuration changes.
5. **View FIM Scan Results Using the Wazuh Dashboard**  
   Navigate to `Home > Endpoint Security > File Integrity Monitoring > Inventory` to view FIM results. The Inventory tab displays an inventory of all files that the FIM module has indexed, including the filename, last modification date, user, user ID, group, and file size. The Dashboard tab provides an overview of FIM results for all enrolled agents. The Event tab shows events generated by the FIM module.

## Changing Default Scan Settings
### Making FIM Module Scans Real-Time
1. **Configure the FIM Module**  
To make the FIM module scan the Downloads and Desktop directories in real-time, add the realtime="yes" attribute as shown below:
      ```xml
      <directories realtime="yes">C:\Users\<YOUR USERNAME>\Downloads</directories>
      <directories realtime="yes">C:\Users\<YOUR USERNAME>\Desktop</directories>
      ```
Note: Only directories with the realtime attribute will be scanned in real-time. Other directories follow the default scan frequency, which is every 12 hours.

2. **Restart the Wazuh Agent**  
Use the command:
      ```xml!
      Restart-Service -Name Wazuh
      ```
3. **Test the Configuration**  
   Create a file named manago.txt in the Downloads directory. The creation of this file should be immediately reflected in the Events tab.
4. **Result**  
   ![ManagoFile added](https://github.com/user-attachments/assets/2aa195d2-a813-4c97-9a4d-318cd84c769b)
### Changing the Frequency of Scans
1. **Configure the FIM Module**  
   Modify the frequency tag in the FIM configuration section to change the scan frequency. For example, setting it to 3:
      ```xml
      <frequency>3</frequency>
      ```
      ![FrequencyChangeTo3s](https://github.com/user-attachments/assets/35618242-83c6-47e5-aa0e-e502744920c3)
2. **Restart the Wazuh Agent**  
   Use the command:
   ```xml
      Restart-Service -Name Wazuh
   ```
3. **Test configuration**  
   A newly added file manago1.txt generate an event after just 3 seconds.  
4. **Result**  
![Manago1 added](https://github.com/user-attachments/assets/93817584-94f4-482b-95d3-93ab87a56ba2)  

### Generating an Alert for File Modification
1. **Modify the File**  
   Open the manago.txt file and add the text "This is THE Lab."

2. **Result**  
   An alert is generated for the file modification in the Events tab.  
   ![ManagoFileChanged](https://github.com/user-attachments/assets/6989cd5e-a5df-44fe-9774-606fc7919883)  

## Reporting Exact Modification Changes  
   Wazuh can report the exact changes made to files it monitors.

1. **Configure the FIM Module**
   Open the ossec.conf file to the File Integrity Monitoring section and add the report_changes attribute:
      ```xml
      <directories report_changes="yes">C:\Users\<YOUR USERNAME>\Downloads</directories>
      ```
      ![ReportExactChangesToFile](https://github.com/user-attachments/assets/1a9ba193-e8dc-4e54-8bd8-1ce42d9eae83)  
2. **Test the Configuration**  
   Add the text "This is THE Lab" to the manago1.txt file. The content of the file should now be "This is THE Lab This is THE Lab."

3. **Result**  
   The exact changes made to the file are reported.
   ![Manago1ChangeReported](https://github.com/user-attachments/assets/78e96fc6-4038-4a53-aa45-bd5d7ad5354c)  

### Preventing Data Leakage with nodiff
   When using the report_changes option, you can use the nodiff option to prevent Wazuh from reporting the exact content changed in a file, thereby avoiding potential data leakage.

### Ignoring Directories
   Wazuh FIM can be configured to ignore specific directories, with ignored directories taking precedence over monitored ones.

1. **Setting Up the Test Environment**  
   Create a folder named Tanubu in the Downloads directory and add a new text document inside it. This newly added file should be displayed in the Wazuh dashboard.

2. **Configure the FIM Module**  
   Open the ossec.conf file and add the path of the Tanubu directory to an ignore tag as shown below:
   ```xml
   <ignore>C:\Users\<YOUR USERNAME>\Downloads\Tanubu</ignore>
   ```
   ![IgnoreCreatedFolder](https://github.com/user-attachments/assets/8e594b67-c40b-4dae-82ca-a3dc6f081585)  

3. **Restart the Wazuh Agent**  
   Use the command:
   ```xml
   Restart-Service -Name Wazuh
   ```
4. **Test the Configuration**  
   Create a text file with text "There will be no change".

5. **Result**  
   The change is not recorded by the FIM module.

### Change Management
   Wazuh monitors file changes, including how, when, and by whom changes are made. Specific metadata to be recorded can be customized if only certain metadata is of interest.

## Use Case: Generate event only for file size modification
1. **Configure the FIM Module**  
   Modify the configuration to monitor changes in file size for files in the Downloads directory:
      ```xml
      <directories check_all="no" check_size="yes">C:\Users\<YOUR USERNAME>\Downloads</directories>
      ```
   ![MonitorFileSizeModification](https://github.com/user-attachments/assets/8e76604b-1fb0-40e9-9baa-d3a0d43152ca)  
   
2.	**Restart the Wazuh Agent**  
   Use the command:
      ```xml
      Restart-Service -Name Wazuh
      ```
3. **Test the Configuration**  
   Remove the content of the manago1.txt file.
4.	**Result**
   An alert is generated for the modification, but only the change in size is displayed.  
   ![ChangeInFileSizeReport](https://github.com/user-attachments/assets/dc3abb97-6ddf-4209-9faa-d7d9bb9f7644)  

### Monitoring Who and What Process Made Changes
   Wazuh can be configured to report who made changes and what process was used to make those changes.

1. **Configure the FIM Module**  
   Modify the configuration to include the whodata attribute:
      ```xml
      <directories check_all="yes" whodata="yes">C:\Users\<YOUR USERNAME>\Downloads</directories>
      ```
2.	**Restart the Wazuh Agent**
   Use the command:
      ```xml
      Restart-Service -Name Wazuh
      ```
3. **Test the Configuration**  
   Add the text "Who Changed Me" to the manago.txt file using Notepad.
4.	**Result**  
   An alert is generated for the modification, and this time, the process (Notepad) and user (in this case, Python) who made the changes are reported.  
![ReportWhoMadeChanges](https://github.com/user-attachments/assets/7f5967dc-bbc4-4727-aada-df2fb252be9f)  

### Detecting Malware Persistence Techniques Using Wazuh FIM
   A threat actor might achieve persistence by adding a malicious script or program to the startup folder of a Windows endpoint. To mitigate this, the FIM module can be configured to scan the Windows startup folder.

1. **Configure the FIM Module**  
   Add the following configuration to monitor the startup folder in real-time:
      ```xml
      <directories realtime="yes">%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup</directories>
      ```  
      ![MonitorStartupFolder](https://github.com/user-attachments/assets/1020b8f4-f3bf-4934-8bcb-64b5f8e2fd8d)  
2. **Test the Configuration**
   Add Microsoft Edge to the startup folder.
3.	**Result**
   All startup program files are recorded, and any addition or modification to these files generates alerts that can be visualized in the dashboard.

### Windows Registry Monitoring
   Wazuh can be used to monitor changes in the Windows registry, such as software installations.

## Use Case: Monitoring Software Installations on an Endpoint
   Software installed for the current user is located at HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\UNINSTALL, and 32-bit programs are located at HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432NodeMICROSOFT\WINDOWS\CURRENTVERSION\UNINSTALL.

1. **Configure the FIM Module**  
   When configuring the FIM module to monitor the Windows registry, use the <windows_registry> tag instead of the <directories> tag:
      ```xml
      <windows_registry recursion_level="512">HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\UNINSTALL</windows_registry>
      ```
      ```xml
      <windows_registry recursion_level="512">HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432NodeMICROSOFT\WINDOWS\CURRENTVERSION\UNINSTALL</windows_registry>
      ```  
      ![ReportChangesToStartupFlder](https://github.com/user-attachments/assets/b229400e-aa87-4433-a555-8f77307c57b0)  
      
2. **Test the Configuration**  
   Download and install 7zip.
3. **Result**  
   ![ChangeInEndpointSoftware](https://github.com/user-attachments/assets/eaa9eb2a-e482-4215-8f66-b169bb7a9e65)  
### Malware Detection
## Using the FIM Module for Malware Detection
   **File Creation and Modification as Indicators of Malware Behavior**
      The Wazuh FIM module is already monitoring file creation and modification, which are typical behaviors of malware. To fine-tune the detection of malware based on these file operations, specific rules can be created. For example, the following rules generate alerts when a potential scripting file is created or modified on a web server endpoint:

### Using the FIM Module and CDB List for Malware Detection
**CDB List Overview**  
   A CDB (Compact DataBase) list is a text file used to store a list of users, file hashes, IP addresses, and domain names. Depending on how the FIM module is configured to use the list, it can either allow or deny based on the contents. Wazuh can be configured to detect malicious files by checking for their signatures in a CDB list. It can also check for malicious IP addresses and domains by listing them in the CDB list.

## Use Case: Detecting Malware Using File Hashes in a CDB List
1.	**Create a CDB List File**  
   The CDB list is created on the server using the following command:
      ```xml
      sudo nano /var/ossec/etc/lists/malware-hashes
      ```
2. **Add hash of known malware**  
   Known malware hashes are written to the file as key pairs. For example, the MD5 hash of the Xbash malware is written as follows:
      ```xml
      55142f1d393c5ba7405239f232a6c059:Xbash
      ```
3.	**Another Example - Creating a Malware File**
   A text file named "malware" containing the text "This is a malware attempt" is created in the Downloads folder. The hash of this file is obtained using the following command in PowerShell:
   ```xml
   Get-FileHash -Algorithm MD5 C:\Users\<YOUR USERNAME>\Downloads\malware.txt
   ```
   The MD5 hash is then added to the CDB list, so the file is recognized as malware. The content of the CDB file are;
   
   Delete the malware file.
4.	**Creating Custom Rules to use CDB List**  
   The following custom rules are set up to match FIM results and generate alerts if a file with a known malware hash is detected:
      ```xml
      <group name="malware,">
        <rule id="100002" level="13">
          <if_sid>554, 550</if_sid>
          <list field="sha256" lookup="match_key">etc/lists/malware-hashes</list>
          <description>File with known malware hash detected: $(file)</description>
        </rule>
      </group>
      
      <group name="malware,">
        <rule id="100003" level="13">
          <if_sid>554, 550</if_sid>
          <list field="md5" lookup="match_key">etc/lists/malware-hashes</list>
          <description>File with known malware hash detected: $(file)</description>
        </rule>
      </group>
      ```
6.	**Restart the Wazuh Manager**  
   Use the following command:
      ```xml
  	   systemctl restart wazuh-manager
      ```
7. **Testing the congiguration**
   Open PowerShell in administrator mode and download the Xbash Malware. Use command ```xml Invoke-WebRequest -Uri "https://wazuh-demo.s3-us-west-1.amazonaws.com/xbash" -OutFile "$env:USERPROFILE\Downloads\Xbash"```.  
   Recreate the Malware file in the downloads folder with the same text, "This is a malware attempt".
8. **Result**
     Both Xbash and the created malware file are detected.  
   ![CDBLIstMalwaresDetected](https://github.com/user-attachments/assets/edf888dd-8b90-415b-9e90-777bf7ac3beb)  

### Detecting Malware Using FIM and VirusTotal
   Wazuh can be integrated with VirusTotal to submit files hashes to the platform and get results of antivirus scan.
1. **Configure Wazuh Manager**
   Append the following code
      ```xml
         <integration>
           <name>virustotal</name>
           <api_key>API_KEY</api_key> <!-- Replace with your VirusTotal API key -->
           <group>syscheck</group>
           <alert_format>json</alert_format>
         </integration>
      ``` to the wazuh configuration file located at `/var/ossec/etc/ossec.conf`
Replace API_KEY with an actual VirusTotal key.
2. **Restart Wazuh Manager**
   Use command: ```xml systemctl restart wazuh-manager ```
3. **Test Configuration**  
   Download mirai virus to the Downloads folder. Use command:
      ```xml
         Invoke-WebRequest -Uri "https://wazuh-demo.s3-us-west-1.amazonaws.com/mirai" -OutFile "$env:USERPROFILE\Downloads\mirai"
      ```
4. **Result**  
   ![VirusTotalDetectMiraiMalware](https://github.com/user-attachments/assets/68abd953-1397-4bce-9ad8-3dad5e323435)

## Collecting Logs from Windows Defender
1.	**Identify Windows Defender Logs**
   Wazuh needs to know the location where Windows Defender logs are kept. To find this, use Windows Event Manager. Navigate to `Applications and Services Logs > Microsoft > Windows > Windows Defender` and select Properties.
  	![WindowsDefenderProperties](https://github.com/user-attachments/assets/15d17577-9b87-4830-a919-52e7c4ec3364)  
![Windows defender full name](https://github.com/user-attachments/assets/2da61fd1-7150-46ba-b2d3-a3e15d30a664)  

3.	**Configure Wazuh Agent to Collect Logs**
   Once the location is known, configure the Wazuh agent to collect the logs by adding the following to the configuration file:
      ```xml
      <localfile>
        <location>Microsoft-Windows-Windows Defender/Operational</location>
        <log_format>eventchannel</log_format>
      </localfile>
      ```
4. **Result**
   Windows logs are ingested by wazuh and can be viewed in the events tab.

### Rootkit Detection
## Overview of Wazuh Rootkit Module
   **Rootkit Module Functionality**
      The Wazuh rootkit module monitors directories, files, registry entries, and the system for rootkits and trojans. It uses out-of-the-box and custom signatures for rootkits and trojans. The module ensures consistency in the output of related commands, making it difficult for rootkits to hide. For instance, if a rootkit attempts to prevent itself from being listed in running processes, the rootkit detection module invokes multiple system calls to compare outputs and identify discrepancies.

## Configure Rootkit Check Signatures
1.	**Fine-tune Rootkit Operations**  
   The files rootkit_files.txt and rootkit_trojan.txt are used to fine-tune the operations of the rootkit detection module. The rootkit_files.txt should contain a list of known trojan directories and files, while rootkit_trojans.txt contains a list of signatures of files that have been trojaned by rootkits.
      ```xml
      <rootcheck>
        <rootkit_files>etc/shared/rootkit_files.txt</rootkit_files>
        <rootkit_trojans>etc/shared/rootkit_trojans.txt</rootkit_trojans>
      </rootcheck>
      ```
